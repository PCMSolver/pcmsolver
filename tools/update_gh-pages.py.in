#!@PYTHON_EXECUTABLE@
# -*- python -*-
# -*- coding: utf-8 -*-
# vim:filetype=python:
# Update contents of @CMAKE_SOURCE_DIR@/doc/html subdirectory
# and push to github repository. Sync both the master and gh-pages branches.
# (c) Roberto Di Remigio  <roberto.d.remigio@uit.no>
# licensed under the GNU Lesser General Public License

import os
import distutils.core
import shutil
import subprocess
import time

source = '@CMAKE_SOURCE_DIR@'
build  = '@CMAKE_BINARY_DIR@'

now = time.strftime('%c')
commit_message = now+' : update Doxygen generated html files.'
FNULL = open(os.devnull, 'w')

def git_command(*args):
    return subprocess.check_call(['git'] + list(args), stdout=FNULL, stderr=subprocess.STDOUT, shell=False)

# Check if @CMAKE_SOURCE_DIR@/doc/html exists, in case it doesn't clone it
if (not(os.path.exists('@CMAKE_SOURCE_DIR@/doc/html'))):
        git_command('clone', 'git@github.com:PCMSolver/pcmsolver-doc.git')
        print('HTML github repository cloned to {}'.format(source+'doc/html'))
# Go to @CMAKE_SOURCE_DIR@/doc/html
os.chdir(source+'/doc/html')

# Check that we are on the master branch, if not switch to master
branch = subprocess.check_output(['git', 'rev-parse', '--symbolic-full-name', '--abbrev-ref', 'HEAD']).rstrip()
if (branch != 'master'):
        git_command('checkout', 'master')
# Copy files from @CMAKE_BINARY_DIR@/doc/html to @CMAKE_SOURCE_DIR@/doc/html
distutils.dir_util.copy_tree(build+'/doc/html', source+'/doc/html')
print('Updated HTML files copied to {}'.format(source+'/doc/html'))

# Add new files and commit changes on master
git_command('add', '.')
git_command('commit', '-m', commit_message)
git_command('push', 'origin', 'master')
print('Add, commit and push to master')

# Now switch to gh-pages, merge and push
git_command('checkout', 'gh-pages')
git_command('merge', 'master')
git_command('push', 'origin', 'gh-pages')
print('Merge and push to gh-pages')

# Switch back to master
git_command('checkout', 'master')

# Go back to @CMAKE_BINARY_DIR@/doc/html
os.chdir(build+'/doc/html')

# vim:et:ts=4:sw=4
